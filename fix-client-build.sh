#!/bin/bash

# ะััััะพะต ะธัะฟัะฐะฒะปะตะฝะธะต ะฟัะพะฑะปะตะผั ัะพ ััะฐัะธัะตัะบะธะผะธ ัะฐะนะปะฐะผะธ React
# ะกะบัะธะฟั ะดะปั ัะฑะพัะบะธ ะบะปะธะตะฝััะบะพะน ัะฐััะธ ะฝะฐ Ubuntu ัะตัะฒะตัะต

set -e

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

PROJECT_DIR="/root/Xpanel"
CLIENT_DIR="${PROJECT_DIR}/client"

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}โ    ะัะฟัะฐะฒะปะตะฝะธะต ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ    โ${NC}"
echo -e "${BLUE}โ         React ะฟัะธะปะพะถะตะฝะธั             โ${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo

# ะัะพะฒะตัะบะฐ ะฟัะฐะฒ root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}โ ะะฐะฟัััะธัะต ัะบัะธะฟั ั ะฟัะฐะฒะฐะผะธ root: sudo $0${NC}"
   exit 1
fi

# ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
if [ ! -d "$PROJECT_DIR" ]; then
    echo -e "${RED}โ ะะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ ะฝะต ะฝะฐะนะดะตะฝะฐ: $PROJECT_DIR${NC}"
    echo -e "${YELLOW}๐ก ะฃะฑะตะดะธัะตัั, ััะพ ะฟัะพะตะบั ะทะฐะณััะถะตะฝ ะฒ /root/Xpanel${NC}"
    exit 1
fi

cd $PROJECT_DIR
echo -e "${GREEN}โ ะะตัะตัะปะธ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ: $PROJECT_DIR${NC}"

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั Node.js
if ! command -v node &> /dev/null; then
    echo -e "${YELLOW}๐ฆ ะฃััะฐะฝะพะฒะบะฐ Node.js...${NC}"
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    apt-get install -y nodejs
    echo -e "${GREEN}โ Node.js ัััะฐะฝะพะฒะปะตะฝ${NC}"
fi

NODE_VERSION=$(node --version)
echo -e "${BLUE}๐ Node.js ะฒะตััะธั: $NODE_VERSION${NC}"

# ะััะฐะฝะพะฒะบะฐ ัะตัะฒะธัะฐ ะฟะตัะตะด ะพะฑะฝะพะฒะปะตะฝะธะตะผ
echo -e "${YELLOW}โน๏ธ  ะััะฐะฝะพะฒะบะฐ ัะตัะฒะธัะฐ Xpanel...${NC}"
systemctl stop xpanel 2>/dev/null || pm2 stop xpanel 2>/dev/null || true

# ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ัะตัะฒะตัะฐ
echo -e "${YELLOW}๐ฆ ะฃััะฐะฝะพะฒะบะฐ ัะตัะฒะตัะฝัั ะทะฐะฒะธัะธะผะพััะตะน...${NC}"
npm install --production

# ะะตัะตัะพะด ะฒ ะบะปะธะตะฝััะบัั ะดะธัะตะบัะพัะธั
if [ ! -d "$CLIENT_DIR" ]; then
    echo -e "${RED}โ ะะปะธะตะฝััะบะฐั ะดะธัะตะบัะพัะธั ะฝะต ะฝะฐะนะดะตะฝะฐ: $CLIENT_DIR${NC}"
    exit 1
fi

cd $CLIENT_DIR
echo -e "${GREEN}โ ะะตัะตัะปะธ ะฒ ะบะปะธะตะฝััะบัั ะดะธัะตะบัะพัะธั${NC}"

# ะฃััะฐะฝะพะฒะบะฐ ะบะปะธะตะฝััะบะธั ะทะฐะฒะธัะธะผะพััะตะน
echo -e "${YELLOW}๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะบะปะธะตะฝััะบะธั ะทะฐะฒะธัะธะผะพััะตะน...${NC}"
npm install

# ะกะพะทะดะฐะฝะธะต .env ัะฐะนะปะฐ ะดะปั production
echo -e "${YELLOW}โ๏ธ  ะกะพะทะดะฐะฝะธะต .env ัะฐะนะปะฐ ะดะปั production...${NC}"
cat > .env << EOF
REACT_APP_API_URL=http://64.188.70.12:3001
REACT_APP_WS_URL=ws://64.188.70.12:3001
GENERATE_SOURCEMAP=false
EOF

# ะกะฑะพัะบะฐ ะบะปะธะตะฝััะบะพะน ัะฐััะธ
echo -e "${YELLOW}๐๏ธ  ะกะฑะพัะบะฐ React ะฟัะธะปะพะถะตะฝะธั...${NC}"
npm run build

# ะัะพะฒะตัะบะฐ ััะฟะตัะฝะพััะธ ัะฑะพัะบะธ
if [ -d "build" ]; then
    echo -e "${GREEN}โ ะะปะธะตะฝััะบะฐั ัะฐััั ััะฟะตัะฝะพ ัะพะฑัะฐะฝะฐ${NC}"
    echo -e "${BLUE}๐ ะกัะฐัะธัะตัะบะธะต ัะฐะนะปั ะฝะฐัะพะดัััั ะฒ: $CLIENT_DIR/build${NC}"
    
    # ะะพะบะฐะทัะฒะฐะตะผ ัะพะดะตัะถะธะผะพะต build ะดะธัะตะบัะพัะธะธ
    echo -e "${BLUE}๐ ะกะพะดะตัะถะธะผะพะต build ะดะธัะตะบัะพัะธะธ:${NC}"
    ls -la build/static/js/ | head -10
else
    echo -e "${RED}โ ะัะธะฑะบะฐ ัะฑะพัะบะธ ะบะปะธะตะฝััะบะพะน ัะฐััะธ${NC}"
    exit 1
fi

# ะะพะทะฒัะฐั ะฒ ะบะพัะฝะตะฒัั ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd $PROJECT_DIR

# ะัะพะฒะตัะบะฐ ะฝะฐัััะพะตะบ ัะตัะฒะตัะฐ ะดะปั ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ
echo -e "${YELLOW}๐ ะัะพะฒะตัะบะฐ ะฝะฐัััะพะตะบ ัะตัะฒะตัะฐ...${NC}"
if grep -q "express.static.*client/build" server/index.js; then
    echo -e "${GREEN}โ ะกะตัะฒะตั ะฝะฐัััะพะตะฝ ะดะปั ะพะฑัะปัะถะธะฒะฐะฝะธั ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ${NC}"
else
    echo -e "${YELLOW}โ๏ธ  ะะพะทะผะพะถะฝะพ, ะฝัะถะฝะพ ะฟัะพะฒะตัะธัั ะฝะฐัััะพะนะบะธ ัะตัะฒะตัะฐ${NC}"
fi

# ะะฐะฟััะบ ัะตัะฒะธัะฐ
echo -e "${YELLOW}๐ ะะฐะฟััะบ ัะตัะฒะธัะฐ Xpanel...${NC}"
if systemctl is-enabled xpanel &>/dev/null; then
    systemctl start xpanel
    sleep 3
    if systemctl is-active --quiet xpanel; then
        echo -e "${GREEN}โ ะกะตัะฒะธั Xpanel ะทะฐะฟััะตะฝ ัะตัะตะท systemd${NC}"
    else
        echo -e "${RED}โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ัะตัะตะท systemd${NC}"
        echo -e "${YELLOW}๐ ะะพะณะธ: journalctl -u xpanel -n 20${NC}"
    fi
elif command -v pm2 &> /dev/null; then
    cd server
    pm2 start index.js --name xpanel
    echo -e "${GREEN}โ ะกะตัะฒะธั Xpanel ะทะฐะฟััะตะฝ ัะตัะตะท PM2${NC}"
else
    echo -e "${YELLOW}โ๏ธ  ะะฐะฟัััะธัะต ัะตัะฒะตั ะฒัััะฝัั:${NC}"
    echo -e "${YELLOW}cd $PROJECT_DIR/server && node index.js${NC}"
fi

# ะัะพะฒะตัะบะฐ Nginx (ะตัะปะธ ัััะฐะฝะพะฒะปะตะฝ)
if command -v nginx &> /dev/null; then
    echo -e "${YELLOW}๐ ะัะพะฒะตัะบะฐ Nginx...${NC}"
    if systemctl is-active --quiet nginx; then
        echo -e "${GREEN}โ Nginx ัะฐะฑะพัะฐะตั${NC}"
        
        # ะัะพะฒะตัะบะฐ ะบะพะฝัะธะณััะฐัะธะธ ะดะปั ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ
        if [ -f "/etc/nginx/sites-available/xpanel" ]; then
            echo -e "${GREEN}โ ะะพะฝัะธะณััะฐัะธั Nginx ะดะปั Xpanel ะฝะฐะนะดะตะฝะฐ${NC}"
        else
            echo -e "${YELLOW}โ๏ธ  ะกะพะทะดะฐะนัะต ะบะพะฝัะธะณััะฐัะธั Nginx ะดะปั ะปัััะตะน ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ${NC}"
        fi
    else
        echo -e "${YELLOW}โ๏ธ  Nginx ะฝะต ะทะฐะฟััะตะฝ${NC}"
    fi
fi

echo
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ        ะัะฟัะฐะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ!        โ${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo
echo -e "${BLUE}๐ ะัะพะฒะตัััะต ะดะพัััะฟะฝะพััั:${NC}"
echo -e "${YELLOW}  http://64.188.70.12:3001${NC}"
echo -e "${YELLOW}  http://xpanel.xload.ru${NC}"
echo
echo -e "${BLUE}๐ง ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั:${NC}"
echo -e "${YELLOW}  ะกัะฐััั ัะตัะฒะธัะฐ: systemctl status xpanel${NC}"
echo -e "${YELLOW}  ะะพะณะธ ัะตัะฒะธัะฐ:   journalctl -u xpanel -f${NC}"
echo -e "${YELLOW}  PM2 ััะฐััั:     pm2 status${NC}"
echo -e "${YELLOW}  PM2 ะปะพะณะธ:       pm2 logs xpanel${NC}"
echo
echo -e "${GREEN}๐ ะกัะฐัะธัะตัะบะธะต ัะฐะนะปั React ัะตะฟะตัั ะดะพะปะถะฝั ะทะฐะณััะถะฐัััั ะบะพััะตะบัะฝะพ!${NC}"
