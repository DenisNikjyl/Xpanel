# Xpanel - Реальная система управления серверами

## Обзор изменений

Система была полностью переработана для обеспечения **реального SSH подключения** и **настоящей установки агентов** на удаленные серверы. Теперь вы можете:

- ✅ Устанавливать агенты на реальные серверы через SSH
- ✅ Получать реальную статистику серверов в реальном времени
- ✅ Выполнять команды на удаленных серверах
- ✅ Мониторить состояние серверов через WebSocket
- ✅ Управлять SSH соединениями с автоматической очисткой

## Новые компоненты

### 1. SSH Manager (`ssh_manager.py`)
Улучшенный менеджер SSH соединений с:
- Пулом соединений для оптимизации
- Автоматической очисткой неактивных соединений
- Поддержкой SSH ключей и паролей
- Обработкой ошибок и таймаутов

### 2. Real Agent Installer (`real_agent_installer.py`)
Система реальной установки агентов:
- Пошаговая установка с прогрессом в реальном времени
- Проверка системных требований
- Автоматическая установка зависимостей
- Создание systemd сервиса
- WebSocket уведомления о прогрессе

### 3. Real Monitoring (`static/js/real_monitoring.js`)
JavaScript система мониторинга:
- WebSocket подключение для реального времени
- Прогресс установки агентов
- Уведомления и терминал установки
- Обновление статистики серверов

## Установка и запуск

### 1. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 2. Настройка окружения
Создайте файл `.env`:
```env
SECRET_KEY=your-secret-key-here
JWT_SECRET_KEY=your-jwt-secret-here
```

### 3. Запуск приложения
```bash
python app.py
```

Приложение будет доступно по адресу: http://localhost:5000

## Использование системы

### Добавление сервера

1. Откройте панель управления
2. Перейдите в раздел "Servers"
3. Нажмите "Add Server"
4. Заполните данные:
   - **Name**: Имя сервера
   - **Host**: IP адрес или домен
   - **Port**: SSH порт (по умолчанию 22)
   - **Username**: Имя пользователя SSH
   - **Password** или **SSH Key**: Метод аутентификации

### Установка агента

1. После добавления сервера нажмите "Install Agent"
2. Система автоматически:
   - Подключится к серверу по SSH
   - Проверит системные требования
   - Установит зависимости Python
   - Создаст агент в `/opt/xpanel-agent/`
   - Настроит systemd сервис
   - Запустит агент

3. Прогресс установки отображается в реальном времени

### Мониторинг серверов

После установки агента сервер будет:
- Отправлять статистику каждые 30 секунд
- Показывать реальные данные CPU, памяти, диска
- Обновлять статус в реальном времени
- Отображать время последнего обновления

### Выполнение команд

1. Выберите сервер
2. Нажмите "Execute Command"
3. Введите команду
4. Получите результат выполнения

## Структура агента

Агент устанавливается в `/opt/xpanel-agent/` и включает:

```
/opt/xpanel-agent/
├── xpanel_agent.py      # Основной скрипт агента
├── agent.log            # Лог файл
└── ...
```

Systemd сервис: `/etc/systemd/system/xpanel-agent.service`

## Управление агентом

### Проверка статуса
```bash
sudo systemctl status xpanel-agent
```

### Перезапуск
```bash
sudo systemctl restart xpanel-agent
```

### Просмотр логов
```bash
sudo journalctl -u xpanel-agent -f
```

### Удаление агента
```bash
sudo systemctl stop xpanel-agent
sudo systemctl disable xpanel-agent
sudo rm -f /etc/systemd/system/xpanel-agent.service
sudo rm -rf /opt/xpanel-agent
sudo systemctl daemon-reload
```

## API Endpoints

### Установка агента
```http
POST /api/servers/install-agent
Content-Type: application/json
Authorization: Bearer <token>

{
    "host": "192.168.1.100",
    "port": 22,
    "username": "root",
    "password": "password",
    "name": "Web Server"
}
```

### Выполнение команды
```http
POST /api/servers/execute
Content-Type: application/json
Authorization: Bearer <token>

{
    "server_id": "1",
    "command": "uptime",
    "timeout": 30
}
```

### Тестирование соединения
```http
POST /api/servers/<server_id>/test
Authorization: Bearer <token>
```

## WebSocket События

### Прогресс установки
```javascript
socket.on('installation_progress', (data) => {
    console.log('Progress:', data.progress);
});
```

### Завершение установки
```javascript
socket.on('installation_complete', (data) => {
    console.log('Result:', data.result);
});
```

### Статистика серверов
```javascript
socket.on('server_stats', (data) => {
    console.log('Stats:', data.stats);
});
```

## Безопасность

### SSH Ключи
Рекомендуется использовать SSH ключи вместо паролей:

1. Создайте SSH ключ:
```bash
ssh-keygen -t rsa -b 4096 -C "xpanel@yourdomain.com"
```

2. Скопируйте публичный ключ на сервер:
```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub user@server
```

3. Используйте приватный ключ в Xpanel

### Права доступа
Агент требует права sudo для:
- Установки пакетов
- Создания systemd сервиса
- Мониторинга системы

## Устранение неполадок

### Ошибка подключения SSH
1. Проверьте доступность сервера: `ping <host>`
2. Проверьте SSH порт: `telnet <host> <port>`
3. Проверьте учетные данные
4. Проверьте SSH ключи

### Ошибка установки агента
1. Проверьте права sudo пользователя
2. Проверьте доступность пакетного менеджера
3. Проверьте подключение к интернету на сервере
4. Просмотрите логи установки

### Агент не отправляет данные
1. Проверьте статус сервиса: `systemctl status xpanel-agent`
2. Проверьте логи: `journalctl -u xpanel-agent`
3. Проверьте сетевое подключение к панели
4. Проверьте настройки firewall

## Мониторинг производительности

### SSH соединения
Система автоматически:
- Переиспользует существующие соединения
- Закрывает неактивные соединения через 30 минут
- Проверяет состояние соединений

### Статистика соединений
```javascript
// Получить статистику SSH соединений
fetch('/api/ssh/stats', {
    headers: { 'Authorization': `Bearer ${token}` }
})
.then(response => response.json())
.then(data => console.log(data));
```

## Логирование

### Панель управления
Логи приложения: `app.log`

### SSH Manager
Логи SSH соединений в консоли приложения

### Агенты
Логи каждого агента: `/opt/xpanel-agent/agent.log`

## Масштабирование

Система поддерживает:
- Неограниченное количество серверов
- Пул SSH соединений
- Асинхронную обработку команд
- WebSocket для реального времени

## Поддержка ОС

### Поддерживаемые системы
- ✅ Ubuntu 18.04+
- ✅ Debian 9+
- ✅ CentOS 7+
- ✅ RHEL 7+
- ✅ Fedora 30+

### Требования
- Python 3.6+
- systemd
- sudo права
- SSH доступ

## Обновления

Для обновления системы:
1. Остановите приложение
2. Обновите код
3. Установите новые зависимости: `pip install -r requirements.txt`
4. Запустите приложение

Агенты обновляются автоматически при переустановке.

---

**Поздравляем!** Теперь у вас есть полноценная система управления серверами с реальным SSH подключением и мониторингом в реальном времени.
